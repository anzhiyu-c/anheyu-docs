name: ðŸš€ Deploy to Baota Server

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    name: ðŸ—ï¸ Build and Deploy
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # 2. è®¾ç½® pnpm
      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      # 3. è®¾ç½® Node.js çŽ¯å¢ƒ
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm"

      # 4. å®‰è£…ä¾èµ–
      - name: ðŸ“¦ Install dependencies
        run: pnpm install

      # 5. æž„å»ºé¡¹ç›®
      - name: ðŸ—ï¸ Build project
        run: pnpm run build

      # 6. åˆ›å»ºéƒ¨ç½²åŒ…
      - name: ðŸ“¦ Create deployment package
        run: |
          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          mkdir -p deploy

          # å¤åˆ¶å¿…è¦æ–‡ä»¶åˆ°éƒ¨ç½²ç›®å½•
          cp -r .next deploy/
          cp -r content deploy/
          cp -r public deploy/
          cp -r src deploy/
          cp package.json deploy/
          cp next.config.mjs deploy/
          cp tsconfig.json deploy/
          cp postcss.config.mjs deploy/ 2>/dev/null || echo "postcss.config.mjs not found, skipping"
          cp tailwind.config.ts deploy/ 2>/dev/null || echo "tailwind.config.ts not found, skipping"  
          cp source.config.ts deploy/

          # åˆ›å»ºç”Ÿäº§çŽ¯å¢ƒçš„ package.jsonï¼ˆä»…åŒ…å«è¿è¡Œæ—¶ä¾èµ–ï¼‰
          node -e "
            const pkg = require('./package.json');
            const prodPkg = {
              name: pkg.name,
              version: pkg.version,
              scripts: {
                start: pkg.scripts.start
              },
              dependencies: pkg.dependencies
            };
            require('fs').writeFileSync('./deploy/package.json', JSON.stringify(prodPkg, null, 2));
          "

          # åŽ‹ç¼©éƒ¨ç½²åŒ…
          cd deploy
          tar -czf ../anheyu-docs-$(date +%Y%m%d-%H%M%S).tar.gz .
          cd ..

          # åˆ›å»ºæœ€æ–°ç‰ˆæœ¬çš„è½¯é“¾æŽ¥
          ln -sf anheyu-docs-$(date +%Y%m%d-%H%M%S).tar.gz anheyu-docs-latest.tar.gz

      # 7. éƒ¨ç½²åˆ°æœåŠ¡å™¨
      - name: ðŸš€ Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          timeout: 60s
          command_timeout: 10m
          script: |
            echo "ðŸš€ Starting deployment..."

            # è®¾ç½®å˜é‡
            PROJECT_DIR="/www/wwwroot/anheyu-docs"
            BACKUP_DIR="/www/backup/anheyu-docs"
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)

            # åˆ›å»ºå¤‡ä»½ç›®å½•
            mkdir -p $BACKUP_DIR

            # å¤‡ä»½å½“å‰ç‰ˆæœ¬
            if [ -d "$PROJECT_DIR" ]; then
              echo "ðŸ“¦ Creating backup..."
              tar -czf $BACKUP_DIR/backup-$TIMESTAMP.tar.gz -C $PROJECT_DIR . 2>/dev/null || echo "Backup failed, continuing..."
              
              # æ¸…ç†æ—§å¤‡ä»½ï¼Œåªä¿ç•™æœ€æ–°çš„3ä»½
              echo "ðŸ§¹ Cleaning old backups (keeping only 3 most recent)..."
              cd $BACKUP_DIR
              ls -t backup-*.tar.gz 2>/dev/null | tail -n +4 | xargs -r rm -f 2>/dev/null || echo "No old backups to clean"
              BACKUP_COUNT=$(ls -1 backup-*.tar.gz 2>/dev/null | wc -l || echo "0")
              echo "ðŸ“Š Current backup count: $BACKUP_COUNT"
            fi

            # åˆ›å»ºé¡¹ç›®ç›®å½•
            mkdir -p $PROJECT_DIR

            # ä¸‹è½½éƒ¨ç½²åŒ…
            echo "ðŸ“¥ Downloading deployment package..."
            cd /tmp

            # åœæ­¢å½“å‰æœåŠ¡
            echo "â¹ï¸ Stopping current service..."
            pm2 stop anheyu-docs 2>/dev/null || echo "Service not running"

      # 8. ä¸Šä¼ éƒ¨ç½²åŒ…å¹¶è§£åŽ‹
      - name: ðŸ“¤ Upload and extract
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          timeout: 60s
          source: "anheyu-docs-latest.tar.gz"
          target: "/tmp/"

      # 9. å®Œæˆéƒ¨ç½²
      - name: âœ… Complete deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          timeout: 60s
          command_timeout: 15m
          script: |
            echo "ðŸ“¦ Extracting deployment package..."

            PROJECT_DIR="/www/wwwroot/anheyu-docs"

            # è§£åŽ‹åˆ°é¡¹ç›®ç›®å½•
            cd $PROJECT_DIR
            tar -xzf /tmp/anheyu-docs-latest.tar.gz

            # è®¾ç½®æƒé™
            chown -R www:www $PROJECT_DIR
            chmod -R 755 $PROJECT_DIR

            # å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆæž„å»ºéœ€è¦devDependenciesï¼‰
            echo "ðŸ“¦ Installing all dependencies..."
            export NODE_ENV=production
            pnpm install 2>/dev/null || npm install

            # å¯åŠ¨æœåŠ¡
            echo "ðŸš€ Starting service using Baota script..."

            # 1. æ€æ­»3000ç«¯å£çš„å ç”¨è¿›ç¨‹
            echo "ðŸ”ª Killing processes on port 3000..."
            lsof -ti:3000 | xargs -r kill -9 2>/dev/null || echo "No process found on port 3000"

            # 2. åœæ­¢çŽ°æœ‰çš„å®å¡”ç®¡ç†çš„è¿›ç¨‹ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
            if [ -f "/www/server/nodejs/vhost/pids/anheyu_docs.pid" ]; then
                PID=$(cat /www/server/nodejs/vhost/pids/anheyu_docs.pid 2>/dev/null || echo "")
                if [ ! -z "$PID" ] && kill -0 $PID 2>/dev/null; then
                    echo "ðŸ“ Stopping existing Baota process (PID: $PID)..."
                    kill -9 $PID 2>/dev/null || echo "Process already stopped"
                fi
                rm -f /www/server/nodejs/vhost/pids/anheyu_docs.pid
            fi

            # 3. ä½¿ç”¨å®å¡”å¯åŠ¨è„šæœ¬å¯åŠ¨é¡¹ç›®
            echo "ðŸŽ¯ Running Baota startup script..."
            sh /www/server/nodejs/vhost/scripts/anheyu_docs.sh

            # 4. ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ Waiting for service to start..."
            sleep 5

            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f /tmp/anheyu-docs-latest.tar.gz

            echo "âœ… Deployment completed successfully!"
            echo "ðŸŒ Your site should be available at your configured domain"

            # æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
            echo "ðŸ“Š Checking service status..."
            if [ -f "/www/server/nodejs/vhost/pids/anheyu_docs.pid" ]; then
                PID=$(cat /www/server/nodejs/vhost/pids/anheyu_docs.pid)
                if kill -0 $PID 2>/dev/null; then
                    echo "âœ… Baota service is running (PID: $PID)"
                else
                    echo "âš ï¸  PID file exists but process is not running"
                fi
            else
                echo "âš ï¸  No PID file found"
            fi

      # 10. å¥åº·æ£€æŸ¥
      - name: ðŸ¥ Health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          timeout: 60s
          command_timeout: 5m
          script: |
            echo "ðŸ¥ Performing health check..."

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 10

            # æ£€æŸ¥ç«¯å£æ˜¯å¦ç›‘å¬
            if netstat -tlnp | grep :3000; then
              echo "âœ… Service is listening on port 3000"
            else
              echo "âŒ Service is not listening on port 3000"
              exit 1
            fi

            # æ£€æŸ¥å®å¡”è¿›ç¨‹çŠ¶æ€ï¼ˆå¯é€‰æ£€æŸ¥ï¼‰
            echo "ðŸ” Checking Baota process status..."
            if [ -f "/www/server/nodejs/vhost/pids/anheyu_docs.pid" ]; then
              PID=$(cat /www/server/nodejs/vhost/pids/anheyu_docs.pid)
              if kill -0 $PID 2>/dev/null; then
                echo "âœ… Baota process is running (PID: $PID)"
              else
                echo "âš ï¸  Baota PID file exists but process is not running"
              fi
            else
              echo "âš ï¸  No Baota PID file found, but service is running on port 3000"
            fi

            # æ£€æŸ¥ Next.js è¿›ç¨‹
            echo "ðŸ” Checking Next.js process..."
            NEXT_PID=$(lsof -ti:3000 2>/dev/null || echo "")
            if [ ! -z "$NEXT_PID" ]; then
              echo "âœ… Next.js process is running (PID: $NEXT_PID)"
            fi

            echo "ðŸŽ‰ Health check passed! Deployment successful!"
            echo "ðŸ“Š Service is running on port 3000 and ready to serve requests!"
