name: ğŸš€ Deploy SSG to Baota Server

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸ—ï¸ Build and Deploy SSG
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # 2. è®¾ç½® pnpm
      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      # 3. è®¾ç½® Node.js ç¯å¢ƒ
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm"

      # 4. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      # 5. æ„å»ºé™æ€ç«™ç‚¹
      - name: ğŸ—ï¸ Build static site
        run: pnpm run build

      # 6. åˆ›å»ºé™æ€ç«™ç‚¹éƒ¨ç½²åŒ…
      - name: ğŸ“¦ Create static deployment package
        run: |
          # æ£€æŸ¥æ„å»ºäº§ç‰©
          if [ ! -d "out" ]; then
            echo "âŒ Build output directory 'out' not found!"
            echo "ğŸ“‚ Available directories:"
            ls -la
            exit 1
          fi

          echo "ğŸ“ Contents of out directory:"
          ls -la out/

          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          echo "ğŸ” Checking key files in out directory:"
          [ -f "out/index.html" ] && echo "âœ… index.html found" || echo "âŒ index.html missing"
          [ -f "out/static.json" ] && echo "âœ… static.json found" || echo "âŒ static.json missing"
          [ -d "out/_next" ] && echo "âœ… _next directory found" || echo "âŒ _next directory missing"

          # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
          FILE_COUNT=$(find out -type f | wc -l)
          echo "ğŸ“Š Total files in out directory: $FILE_COUNT"

          # å‹ç¼©é™æ€æ–‡ä»¶
          echo "ğŸ“¦ Creating deployment package..."
          cd out
          tar -czf ../dev-anheyu-com-static-$(date +%Y%m%d-%H%M%S).tar.gz .
          cd ..

          # åˆ›å»ºæœ€æ–°ç‰ˆæœ¬çš„è½¯é“¾æ¥
          ln -sf dev-anheyu-com-static-$(date +%Y%m%d-%H%M%S).tar.gz dev-anheyu-com-static-latest.tar.gz

          # éªŒè¯å‹ç¼©åŒ…
          echo "ğŸ” Verifying deployment package:"
          echo "ğŸ“¦ Package size: $(ls -lh dev-anheyu-com-static-latest.tar.gz | awk '{print $5}')"
          echo "ğŸ“‚ Package contents (first 10 files):"
          tar -tzf dev-anheyu-com-static-latest.tar.gz | head -10

          echo "âœ… Static deployment package created successfully"

      # 7. å‡†å¤‡éƒ¨ç½²ç¯å¢ƒ
      - name: ğŸš€ Prepare deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          timeout: 60s
          command_timeout: 10m
          script: |
            echo "ğŸš€ Starting SSG deployment..."

            # è®¾ç½®å˜é‡
            PROJECT_DIR="/www/wwwroot/dev.anheyu.com"
            BACKUP_DIR="/www/backup/dev.anheyu.com"
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)

            # åˆ›å»ºå¤‡ä»½ç›®å½•
            mkdir -p $BACKUP_DIR

            # å¤‡ä»½å½“å‰ç‰ˆæœ¬
            if [ -d "$PROJECT_DIR" ] && [ "$(ls -A $PROJECT_DIR)" ]; then
              echo "ğŸ“¦ Creating backup of current static files..."
              tar -czf $BACKUP_DIR/backup-$TIMESTAMP.tar.gz -C $PROJECT_DIR . 2>/dev/null || echo "Backup failed, continuing..."
              
              # æ¸…ç†æ—§å¤‡ä»½ï¼Œåªä¿ç•™æœ€æ–°çš„5ä»½
              echo "ğŸ§¹ Cleaning old backups (keeping only 5 most recent)..."
              cd $BACKUP_DIR
              ls -t backup-*.tar.gz 2>/dev/null | tail -n +6 | xargs -r rm -f 2>/dev/null || echo "No old backups to clean"
              BACKUP_COUNT=$(ls -1 backup-*.tar.gz 2>/dev/null | wc -l || echo "0")
              echo "ğŸ“Š Current backup count: $BACKUP_COUNT"
            fi

            echo "âœ… Environment prepared for static deployment"

      # 8. ä¸Šä¼ é™æ€æ–‡ä»¶åŒ…
      - name: ğŸ“¤ Upload static files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          timeout: 60s
          source: "dev-anheyu-com-static-latest.tar.gz"
          target: "/tmp/"

      # 9. éƒ¨ç½²é™æ€æ–‡ä»¶
      - name: âœ… Deploy static files
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          timeout: 60s
          command_timeout: 15m
          script: |
            echo "ğŸ“¦ Deploying static files..."

            PROJECT_DIR="/www/wwwroot/dev.anheyu.com"

            # æ˜¾ç¤ºéƒ¨ç½²å‰çš„ç›®å½•çŠ¶æ€
            echo "ğŸ“‚ Directory status before deployment:"
            ls -la $PROJECT_DIR 2>/dev/null || echo "Directory does not exist"

            # ç¡®ä¿ç›®å½•å­˜åœ¨
            mkdir -p $PROJECT_DIR

            # å®Œå…¨æ¸…ç©ºç›®æ ‡ç›®å½•ï¼ˆä¿ç•™ .htaccess æ–‡ä»¶ï¼‰
            echo "ğŸ§¹ Cleaning target directory..."
            if [ -f "$PROJECT_DIR/.htaccess" ]; then
              echo "ğŸ’¾ Backing up .htaccess..."
              cp "$PROJECT_DIR/.htaccess" "/tmp/.htaccess.backup" 2>/dev/null || echo "No .htaccess to backup"
            fi

            # åˆ é™¤æ‰€æœ‰å†…å®¹
            rm -rf $PROJECT_DIR/* 2>/dev/null || echo "No files to remove"
            rm -rf $PROJECT_DIR/.* 2>/dev/null || echo "No hidden files to remove"

            # æ¢å¤ .htaccess
            if [ -f "/tmp/.htaccess.backup" ]; then
              echo "ğŸ”„ Restoring .htaccess..."
              cp "/tmp/.htaccess.backup" "$PROJECT_DIR/.htaccess"
              rm -f "/tmp/.htaccess.backup"
            fi

            # éªŒè¯å‹ç¼©åŒ…æ˜¯å¦å­˜åœ¨
            echo "ğŸ” Checking deployment package..."
            echo "ğŸ“‚ Package files in /tmp/:"
            ls -la /tmp/dev-anheyu-com-static* 2>/dev/null || echo "No package files found"

            if [ ! -f "/tmp/dev-anheyu-com-static-latest.tar.gz" ]; then
              echo "âŒ Deployment package symlink not found!"
              # å°è¯•æ‰¾åˆ°å®é™…çš„tar.gzæ–‡ä»¶
              ACTUAL_FILE=$(ls /tmp/dev-anheyu-com-static-*.tar.gz 2>/dev/null | head -1)
              if [ -n "$ACTUAL_FILE" ]; then
                echo "ğŸ“ Found actual package file: $ACTUAL_FILE"
                echo "ğŸ”— Creating symlink..."
                ln -sf "$(basename "$ACTUAL_FILE")" "/tmp/dev-anheyu-com-static-latest.tar.gz"
                if [ -f "/tmp/dev-anheyu-com-static-latest.tar.gz" ]; then
                  echo "âœ… Symlink created successfully"
                else
                  echo "âŒ Failed to create symlink"
                  exit 1
                fi
              else
                echo "âŒ No deployment package found at all!"
                exit 1
              fi
            else
              # æ£€æŸ¥ç¬¦å·é“¾æ¥æ˜¯å¦æœ‰æ•ˆ
              if [ ! -e "/tmp/dev-anheyu-com-static-latest.tar.gz" ]; then
                echo "âŒ Deployment package symlink is broken!"
                # å°è¯•ä¿®å¤ç¬¦å·é“¾æ¥
                ACTUAL_FILE=$(ls /tmp/dev-anheyu-com-static-*.tar.gz 2>/dev/null | head -1)
                if [ -n "$ACTUAL_FILE" ]; then
                  echo "ğŸ“ Found actual package file: $ACTUAL_FILE"
                  echo "ğŸ”— Fixing symlink..."
                  rm -f "/tmp/dev-anheyu-com-static-latest.tar.gz"
                  ln -sf "$(basename "$ACTUAL_FILE")" "/tmp/dev-anheyu-com-static-latest.tar.gz"
                  echo "âœ… Symlink fixed"
                else
                  echo "âŒ No actual package file found!"
                  exit 1
                fi
              else
                echo "âœ… Deployment package found"
              fi
            fi

            echo "ğŸ“¦ Package size: $(ls -lh /tmp/dev-anheyu-com-static-latest.tar.gz | awk '{print $5}')"

            # éªŒè¯å‹ç¼©åŒ…å†…å®¹
            echo "ğŸ” Verifying package contents:"
            echo "ğŸ“‚ First 10 files in package:"
            tar -tzf /tmp/dev-anheyu-com-static-latest.tar.gz | head -10

            # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦åœ¨å‹ç¼©åŒ…ä¸­
            if tar -tzf /tmp/dev-anheyu-com-static-latest.tar.gz | grep -q "^index.html$"; then
              echo "âœ… index.html found in package"
            else
              echo "âŒ index.html not found in package"
            fi

            if tar -tzf /tmp/dev-anheyu-com-static-latest.tar.gz | grep -q "^static.json$"; then
              echo "âœ… static.json found in package"
            else
              echo "âŒ static.json not found in package"
            fi

            # è§£å‹é™æ€æ–‡ä»¶åˆ°é¡¹ç›®ç›®å½•
            echo "ğŸ“¦ Extracting static files..."
            cd $PROJECT_DIR
            tar -xzf /tmp/dev-anheyu-com-static-latest.tar.gz

            # éªŒè¯è§£å‹ç»“æœ
            echo "ğŸ“‚ Files after extraction:"
            ls -la $PROJECT_DIR | head -15

            # å†æ¬¡æ£€æŸ¥å…³é”®æ–‡ä»¶
            echo "ğŸ” Verifying extracted files:"
            [ -f "$PROJECT_DIR/index.html" ] && echo "âœ… index.html extracted successfully" || echo "âŒ index.html not found after extraction"
            [ -f "$PROJECT_DIR/static.json" ] && echo "âœ… static.json extracted successfully" || echo "âŒ static.json not found after extraction"
            [ -d "$PROJECT_DIR/_next" ] && echo "âœ… _next directory extracted successfully" || echo "âŒ _next directory not found after extraction"

            # è®¾ç½®æ­£ç¡®çš„æƒé™
            echo "ğŸ”§ Setting permissions..."
            chown -R www:www $PROJECT_DIR
            chmod -R 755 $PROJECT_DIR

            # ç¡®ä¿é™æ€æ–‡ä»¶å¯è¯»
            find $PROJECT_DIR -type f -exec chmod 644 {} \;
            find $PROJECT_DIR -type d -exec chmod 755 {} \;

            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f /tmp/dev-anheyu-com-static-latest.tar.gz

            echo "âœ… Static site deployment completed successfully!"
            echo "ğŸŒ Your static site is now available at your configured domain"

            # æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
            echo "ğŸ“Š Deployment summary:"
            echo "ğŸ“ Target directory: $PROJECT_DIR"
            echo "ğŸ“‚ Files deployed: $(find $PROJECT_DIR -type f | wc -l)"
            echo "ğŸ“¦ Directory size: $(du -sh $PROJECT_DIR | cut -f1)"

            # æ£€æŸ¥å…³é”®æ–‡ä»¶
            echo "ğŸ” Checking key files:"
            [ -f "$PROJECT_DIR/index.html" ] && echo "âœ… index.html found" || echo "âŒ index.html missing"
            [ -f "$PROJECT_DIR/static.json" ] && echo "âœ… static.json found" || echo "âŒ static.json missing"
            [ -d "$PROJECT_DIR/_next" ] && echo "âœ… _next directory found" || echo "âŒ _next directory missing"

      # 10. é™æ€ç«™ç‚¹éªŒè¯
      - name: ğŸ¥ Static site verification
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          timeout: 60s
          command_timeout: 5m
          script: |
            echo "ğŸ¥ Performing static site verification..."

            PROJECT_DIR="/www/wwwroot/dev.anheyu.com"

            # æ£€æŸ¥å¿…è¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            echo "ğŸ” Checking essential files..."

            MISSING_FILES=0

            if [ ! -f "$PROJECT_DIR/index.html" ]; then
              echo "âŒ index.html is missing"
              MISSING_FILES=$((MISSING_FILES + 1))
            else
              echo "âœ… index.html exists"
            fi

            if [ ! -f "$PROJECT_DIR/static.json" ]; then
              echo "âŒ static.json is missing"
              MISSING_FILES=$((MISSING_FILES + 1))
            else
              echo "âœ… static.json exists"
              echo "ğŸ“Š Search index size: $(stat -f%z "$PROJECT_DIR/static.json" 2>/dev/null || stat -c%s "$PROJECT_DIR/static.json") bytes"
            fi

            if [ ! -d "$PROJECT_DIR/_next" ]; then
              echo "âŒ _next directory is missing"
              MISSING_FILES=$((MISSING_FILES + 1))
            else
              echo "âœ… _next directory exists"
            fi

            # æ£€æŸ¥æ–‡ä»¶æƒé™
            echo "ğŸ”’ Checking file permissions..."
            PERM_ISSUES=0

            if [ ! -r "$PROJECT_DIR/index.html" ]; then
              echo "âŒ index.html is not readable"
              PERM_ISSUES=$((PERM_ISSUES + 1))
            else
              echo "âœ… index.html is readable"
            fi

            # æ£€æŸ¥ç›®å½•ç»“æ„
            echo "ğŸ“ Directory structure:"
            ls -la $PROJECT_DIR | head -10

            # ç»Ÿè®¡ä¿¡æ¯
            TOTAL_FILES=$(find $PROJECT_DIR -type f | wc -l)
            TOTAL_SIZE=$(du -sh $PROJECT_DIR | cut -f1)

            echo "ğŸ“Š Final deployment statistics:"
            echo "   ğŸ“‚ Total files: $TOTAL_FILES"
            echo "   ğŸ“¦ Total size: $TOTAL_SIZE"
            echo "   ğŸ“ Location: $PROJECT_DIR"

            # æœ€ç»ˆéªŒè¯
            if [ $MISSING_FILES -eq 0 ] && [ $PERM_ISSUES -eq 0 ]; then
              echo "ğŸ‰ Static site verification passed!"
              echo "âœ… All essential files are present and accessible"
              echo "ğŸŒ Your static documentation site is ready!"
              echo ""
              echo "ğŸ’¡ Next steps:"
              echo "   - Configure your web server (Nginx/Apache) to serve static files"
              echo "   - Ensure your domain points to $PROJECT_DIR"
              echo "   - Test the site in your browser"
            else
              echo "âŒ Static site verification failed!"
              echo "   Missing files: $MISSING_FILES"
              echo "   Permission issues: $PERM_ISSUES"
              exit 1
            fi
